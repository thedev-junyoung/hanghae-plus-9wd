## âœ… V2: ì£¼ë¬¸ ìƒíƒœ í™•ì • ì‹¤íŒ¨ ë° ì™¸ë¶€ ì‹œìŠ¤í…œ ì „ì†¡ ì²˜ë¦¬ê¹Œì§€ í¬í•¨í•œ ê²°ì œ íë¦„

### ğŸ“Œ í•µì‹¬ ë³€ê²½ ì‚¬í•­ ìš”ì•½

> í•µì‹¬ ì¶”ê°€ ì‚¬í•­:
>
> ì£¼ë¬¸ê³¼ ê²°ì œë¥¼ ë¶„ë¦¬ëœ ë„ë©”ì¸ìœ¼ë¡œ ì„¤ê³„í•˜ê³ , **ê²°ì œ ì„±ê³µ ì‹œ ì£¼ë¬¸ì´ í™•ì •(CONFIRMED)**ëœë‹¤.
>
> ê²°ì œ ì²˜ë¦¬ ì„±ê³µ ì‹œ, Payment ì—”í‹°í‹°ëŠ” OrderConfirmedEventë¥¼ ë“±ë¡í•˜ê³  ApplicationEventPublisherë¥¼ í†µí•´ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•œë‹¤.
> 
> ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” OrderUseCase.confirmOrder()ë¥¼ í˜¸ì¶œí•˜ì—¬ ì£¼ë¬¸ ìƒíƒœë¥¼ CONFIRMEDë¡œ ë³€ê²½í•œë‹¤.
> 
> ì´ ê³¼ì •ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ OrderConfirmationFailedEventê°€ ë°œí–‰ë˜ì–´ ì‹¤íŒ¨ ì›ì¸ì„ ì¶”ì í•˜ê³  í›„ì† ì¡°ì¹˜ë¥¼ ìœ„í•œ ì•Œë¦¼ ë˜ëŠ” ë³´ìƒ íŠ¸ë¦¬ê±°ë¡œ í™œìš©ëœë‹¤.
>
> ì£¼ë¬¸ì´ CONFIRMED ìƒíƒœë¡œ ì „ì´ë˜ë©´, Order ë„ë©”ì¸ì€ ë‚´ë¶€ì—ì„œ ProductSalesRankRecordedEventì™€ OrderExportRequestedEvent ë‘ ê°€ì§€ ë„ë©”ì¸ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€ë¡œ ë“±ë¡í•œë‹¤.
>
> ì´ ì¤‘ OrderExportRequestedEventëŠ” ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ê³¼ì˜ ì—°ë™ì„ ìœ„í•œ ì´ë²¤íŠ¸ë¡œ, íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì´í›„ OrderExportEventHandlerì—ì„œ ìˆ˜ì‹ ë˜ì–´ ì™¸ë¶€ ì „ì†¡ ë¡œì§ì„ ìˆ˜í–‰í•œë‹¤.
>
> ì´ í›„ì† ì²˜ë¦¬ íë¦„ì€ ì™¸ë¶€ ì‹œìŠ¤í…œ ì¥ì• ê°€ ì£¼ë¬¸ íë¦„ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë¶„ë¦¬ë˜ì–´ ìˆìœ¼ë©°, í–¥í›„ Kafka ë˜ëŠ” DLQ ê¸°ë°˜ì˜ ì¬ì²˜ë¦¬ êµ¬ì¡°ë¡œ í™•ì¥ ê°€ëŠ¥í•˜ë‹¤.


---

### âœ… ë„ë©”ì¸ ì´ë²¤íŠ¸ íë¦„

```
[ê²°ì œ ì„±ê³µ]
 â†’ Payment.createSuccess(...) ë‚´ë¶€ì—ì„œ OrderConfirmedEvent ë“±ë¡
 â†’ @TransactionalEventListener(phase = AFTER_COMMIT) OrderConfirmedEventHandler.handle(...)
     â†’ ì£¼ë¬¸ í™•ì¸ ë¡œì§ í˜¸ì¶œ(OrderUseCase.confirmOrder)
         â†’ CONFIRMED ìƒíƒœë¡œ ì „ì´ ì„±ê³µ ì‹œ:
             - ProductSalesRankRecordedEvent ë“±ë¡
             - OrderExportRequestedEvent ë“±ë¡
             - ë‘ ì´ë²¤íŠ¸ê°€ ì»¤ë°‹ ì´í›„ ë°œí–‰ë¨
         â†’ ì‹¤íŒ¨ ì‹œ:
             - OrderConfirmationFailedEvent ë°œí–‰
             - ë³µêµ¬ ë° ì•Œë¦¼ í•¸ë“¤ë§ ê°€ëŠ¥
 â†’ OrderExportRequestedEventëŠ” OrderExportEventHandlerì—ì„œ ìˆ˜ì‹ 
     â†’ OrderExportService â†’ ExternalPlatformClient (Fake) í†µí•´ ì™¸ë¶€ ì „ì†¡ ìˆ˜í–‰
```

---

### âœ… ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ (V2 ì „ì²´ íë¦„)

```mermaid
sequenceDiagram
    participant Client
    participant PaymentController
    participant PaymentFacadeService
    participant BalanceService
    participant PaymentService
    participant PaymentRepository
    participant EventPublisher
    participant OrderConfirmedEventHandler
    participant OrderUseCase
    participant OrderRepository
    participant OrderConfirmationFailedEventHandler
    participant OrderExportEventHandler
    participant ExternalPlatformClient

    Client->>PaymentController: POST /payments (PaymentRequest)
    PaymentController->>PaymentFacadeService: requestPayment(command)

    PaymentFacadeService->>BalanceService: decreaseBalance(userId, amount)
    alt ì”ì•¡ ë¶€ì¡±
        BalanceService-->>PaymentFacadeService: ì˜ˆì™¸
        PaymentFacadeService-->>PaymentController: 402 Payment Required
        PaymentController-->>Client: ì‹¤íŒ¨ ì‘ë‹µ
    else ì”ì•¡ ì¶©ë¶„
        BalanceService-->>PaymentFacadeService: ì°¨ê° ì™„ë£Œ

        PaymentFacadeService->>PaymentService: recordSuccess(command)

        PaymentService->>Payment: createSuccess()
        Note right of Payment: ë‚´ë¶€ì—ì„œ <br> OrderConfirmedEvent ë“±ë¡

        PaymentService->>PaymentRepository: ê²°ì œ ì •ë³´ ì €ì¥ (SUCCESS)
        PaymentService->>EventPublisher: OrderConfirmedEvent ë°œí–‰
        PaymentService->>PaymentService: payment.clearEvents()
        PaymentService-->>PaymentFacadeService: Payment ê°ì²´ ë°˜í™˜

        PaymentFacadeService-->>PaymentController: ê²°ì œ ì™„ë£Œ ì‘ë‹µ
        PaymentController-->>Client: 200 OK

        Note over OrderConfirmedEventHandler: @TransactionalEventListener(phase = AFTER_COMMIT)
        EventPublisher->>OrderConfirmedEventHandler: OrderConfirmedEvent ìˆ˜ì‹ 

        OrderConfirmedEventHandler->>OrderUseCase: confirmOrder(orderId)

        alt ì˜ˆì™¸ ë°œìƒ
            OrderUseCase-->>OrderConfirmedEventHandler: ìƒíƒœ ì „ì´ ì‹¤íŒ¨
            OrderConfirmedEventHandler->>EventPublisher: OrderConfirmationFailedEvent ë°œí–‰
            EventPublisher->>OrderConfirmationFailedEventHandler: ì‹¤íŒ¨ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
            OrderConfirmationFailedEventHandler-->>Log: ì¥ì•  ë¡œê·¸ ì¶œë ¥ ë° ì•Œë¦¼ ì²˜ë¦¬
        else ì„±ê³µ
            OrderUseCase->>Order: markConfirmed()
            Note right of Order: ProductSalesRankRecordedEvent, OrderExportRequestedEvent ë“±ë¡
            OrderUseCase->>OrderRepository: ì£¼ë¬¸ ìƒíƒœ ì €ì¥
            OrderUseCase->>EventPublisher: ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œí–‰

            EventPublisher->>OrderExportEventHandler: OrderExportRequestedEvent ìˆ˜ì‹ 
            OrderExportEventHandler->>OrderExportService: export(payload)
            OrderExportService->>ExternalPlatformClient: sendOrder(payload)
            ExternalPlatformClient-->>Log: ì™¸ë¶€ ì‹œìŠ¤í…œ ì „ì†¡ ë¡œê·¸ ì¶œë ¥
        end
    end

```

---

### âœ… ì‹¤ì œ ì ìš©ëœ í´ë˜ìŠ¤ ìš”ì•½

| í´ë˜ìŠ¤ | ì—­í•  |
| --- | --- |
| `Payment#createSuccess()` | `OrderConfirmedEvent` ë“±ë¡ |
| `PaymentService#recordSuccess()` | ê²°ì œ ì €ì¥ í›„ ì´ë²¤íŠ¸ ë°œí–‰ |
| `OrderConfirmedEventHandler` | ì£¼ë¬¸ ìƒíƒœ í™•ì • ì‹œë„ |
| `OrderUseCase#confirmOrder()` | CONFIRMED ì „ì´ + í›„ì† ì´ë²¤íŠ¸ ë“±ë¡ |
| `OrderExportRequestedEvent` | ì™¸ë¶€ ì „ì†¡ ìš”ì²­ ë„ë©”ì¸ ì´ë²¤íŠ¸ |
| `OrderExportEventHandler` | ì™¸ë¶€ ì „ì†¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ |
| `OrderExportService` | ì™¸ë¶€ í”Œë«í¼ ì „ì†¡ ì„œë¹„ìŠ¤ |
| `ExternalPlatformClient` | ì‹¤ì œ ì™¸ë¶€ ì—°ë™ êµ¬í˜„ì²´ (Fake) |